/* this is a custom dashboard I created to mimic a previously created dashboard.  I worked with mongoDB and Periscope Data to write SQL commands. It is edited to remove any confidential data adherring to the company */

with payment as 
(SELECT _id as id, job_cost as Client_Pays, payment_amount_for_job as Vendor_Receives_Amount
from mongodb.contract)

, _paid as
(select pai.project_id as id, paid.value as is_paid
from mongodb.project_info pai
left join mongodb.project_info_data paid on pai._id = paid._source_key__id
where paid.info_input_id = 'abc_123')

, po_num as
(select pai.project_id as id, paid.value as Purchase_Order_Number
from mongodb.project_app_info pai
left join mongodb.project_info_data paid on pai._id = paid._source_key__id
where paid.info_input_id = 'def_456')

, fees as 
(SELECT p._id as id, pai.fee_percentage as fee 
from mongodb.projects p
join mongodb.project_info pai on p._id = pai.project_id)

, vendor_name as 
(SELECT c._id as id, (i.first_name || ' ' || i.last_name) as Vendor_Name
from mongodb.identities i
join mongodb.contract c on c.vendor_id = i._id)

, project as 
(SELECT p.project_name as Title
, p.address_secondary as Unit_Number
, p.address as Address
, (i.first_name || ' ' || i.last_name) as Client_Name
, p.accepted_contract_id as contract_id
, p._id as id
, case when p.status = 0 then 'new_project'
       when p.status = 1 then 'in_progress'
       when p.status = 2 then 'project_complete'
       when p.status = 3 then 'payment_received'
       end as Status
, p.created_at as Created_At
, p.completed_on as Completed
, p.verified_on as Verified
, p.bids_count as Bid_Count
 
from mongodb.projects p
left join mongodb.identities i on p.creator_id = i._id

where app_id = '123'
and i.email not like '%company.com')

SELECT project.Title, project.Bid_Count, project.Unit_Number, project.Address, project.Client_Name, vendors_name.Vendor_Name, po_num.Purchase_Order_Number, payment.Client_Pays, payment.Vendor_Receives_Amount, fees.fee, project.Created_At, project.Completed, project.Verified, project.Status, _paid.is_paid

from project
left join vendors_name on vendors_name.id = project.contract_id
left join payment on payment.id = project.contract_id
left join fees on fees.id = project.id
left join po_num on po_num.id = project.id
left join _paid on _paid.id = project.id

where project.Title is not null

group by project.Title, project.Bid_Count, project.Unit_Number, project.Address, project.Client_Name, vendors_name.Vendor_Name, po_num.Purchase_Order_Number, payment.Client_Pays, payment.Vendor_Receives_Amount, fees.fee, project.Created_At, project.Completed, project.Verified, project.Status, _paid.is_paid

order by project.Created_At DESC
