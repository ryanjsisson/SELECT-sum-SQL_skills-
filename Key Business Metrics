/* finding the rate of verified accounts from created accounts */

SELECT cast((verified.values::float / created.values::float) as numeric(10,4))
from

(SELECT COUNT(*) as values
FROM mongodb.identities i
WHERE i._type = 'User' 
AND i.account_verified = true
AND [user_profile_completed]) verified,

(SELECT COUNT(distinct _id) as values
FROM mongodb.identities i
WHERE i._type = 'User' 
AND i.account_verified = true) created


/* finding the average time span from when a job is created to when it is completed */

with post_create as (
select project_id as id, created_at as created
from mongodb.activities
where activity_type = 0
order by project_id, activity_type),

post_complete as (
select project_id as id, created_at as completed
from mongodb.activities
where activity_type = 3
order by project_id, activity_type)

select p.project_type_display_name
, sum(datediff('s', post_create.created, post_complete.completed))/count(*)/3600 as average_time_hours
, sum(datediff('s', post_create.created, post_complete.completed))/count(*)/86400 as average_time_days
from mongodb.projects p
join post_create on post_create.id = p._id
join post_complete on post_complete.id = p._id
group by p.project_type_display_name
order by average_time_hours DESC

/* mapping power users of the platform, who matked the most jobs complete */

with post_complete as (
  SELECT count(_id) as values, creator_id
  FROM mongodb.projects p
  WHERE p.is_posted = true 
  AND p.status_cd >= 3 AND p.status_cd < 8
  group by creator_id)

select case when (post_complete.values <= 5) then '5 or less'
  when (post_complete.values > 5)  and (post_complete.values <= 10) then '5 - 10'
  when (post_complete.values > 10) and (post_complete.values <= 25) then '10 - 25'
  when (post_complete.values > 25) and (post_complete.values <= 50) then '25 - 50'
  when (post_complete.values > 50) and (post_complete.values <= 100) then '50 - 100'
else 'greater than 100'
end as how_many, count(creator_id)
from post_complete
group by post_complete.values
order by how_many

/* finding the average time span from when a job is created to when it is completed */

with post_create as (
select project_id as id, created_at as created
from mongodb.activities
where activity_type_cd in (0)
order by project_id, activity_type_cd),

post_complete as (
select project_id as id, created_at as completed
from mongodb.activities
where activity_type_cd in (3)
order by project_id, activity_type_cd)

select 'Average Post Fulfillment Speed: approx. ' || (sum(datediff('s', post_create.created, post_complete.completed))/count(*))/3600 || 
' hours, or ' || (sum(datediff('s', post_create.created, post_complete.completed))/count(*))/86400 || ' days'
from post_create
inner join post_complete on post_create.id = post_complete.id
